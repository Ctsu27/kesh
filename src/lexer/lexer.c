#include <stdlib.h>
#include "array.h"
#include "lexer_int.h"

#include "ft_printf.h"

int const g_token_definition[TOKEN_STATE_SIZE][128] = {
	[TOKEN_STATE_UNDEFINED] = {
		['\0'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x1'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x2'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x3'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x4'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x5'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x6'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x7'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x8'] = TOKEN_UNDEFINED_UNDEFINED,
		['\t'] = TOKEN_UNDEFINED_UNDEFINED,
		['\n'] = TOKEN_UNDEFINED_UNDEFINED,
		['\xb'] = TOKEN_UNDEFINED_UNDEFINED,
		['\xc'] = TOKEN_UNDEFINED_UNDEFINED,
		['\r'] = TOKEN_UNDEFINED_UNDEFINED,
		['\xe'] = TOKEN_UNDEFINED_UNDEFINED,
		['\xf'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x10'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x11'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x12'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x13'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x14'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x15'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x16'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x17'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x18'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x19'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x1a'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x1b'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x1c'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x1d'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x1e'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x1f'] = TOKEN_UNDEFINED_UNDEFINED,
		[' '] = TOKEN_UNDEFINED_UNDEFINED,
		['!'] = TOKEN_UNDEFINED_UNDEFINED,
		['"'] = TOKEN_UNDEFINED_UNDEFINED,
		['#'] = TOKEN_UNDEFINED_UNDEFINED,
		['$'] = TOKEN_UNDEFINED_UNDEFINED,
		['%'] = TOKEN_UNDEFINED_UNDEFINED,
		['&'] = TOKEN_UNDEFINED_UNDEFINED,
		['\''] = TOKEN_UNDEFINED_UNDEFINED,
		['('] = TOKEN_UNDEFINED_UNDEFINED,
		[')'] = TOKEN_UNDEFINED_UNDEFINED,
		['*'] = TOKEN_UNDEFINED_UNDEFINED,
		['+'] = TOKEN_UNDEFINED_UNDEFINED,
		[','] = TOKEN_UNDEFINED_UNDEFINED,
		['-'] = TOKEN_UNDEFINED_UNDEFINED,
		['.'] = TOKEN_UNDEFINED_UNDEFINED,
		['/'] = TOKEN_UNDEFINED_UNDEFINED,
		['0'] = TOKEN_UNDEFINED_UNDEFINED,
		['1'] = TOKEN_UNDEFINED_UNDEFINED,
		['2'] = TOKEN_UNDEFINED_UNDEFINED,
		['3'] = TOKEN_UNDEFINED_UNDEFINED,
		['4'] = TOKEN_UNDEFINED_UNDEFINED,
		['5'] = TOKEN_UNDEFINED_UNDEFINED,
		['6'] = TOKEN_UNDEFINED_UNDEFINED,
		['7'] = TOKEN_UNDEFINED_UNDEFINED,
		['8'] = TOKEN_UNDEFINED_UNDEFINED,
		['9'] = TOKEN_UNDEFINED_UNDEFINED,
		[':'] = TOKEN_UNDEFINED_UNDEFINED,
		[';'] = TOKEN_UNDEFINED_UNDEFINED,
		['<'] = TOKEN_UNDEFINED_UNDEFINED,
		['='] = TOKEN_UNDEFINED_UNDEFINED,
		['>'] = TOKEN_UNDEFINED_UNDEFINED,
		['?'] = TOKEN_UNDEFINED_UNDEFINED,
		['@'] = TOKEN_UNDEFINED_UNDEFINED,
		['A'] = TOKEN_UNDEFINED_UNDEFINED,
		['B'] = TOKEN_UNDEFINED_UNDEFINED,
		['C'] = TOKEN_UNDEFINED_UNDEFINED,
		['D'] = TOKEN_UNDEFINED_UNDEFINED,
		['E'] = TOKEN_UNDEFINED_UNDEFINED,
		['F'] = TOKEN_UNDEFINED_UNDEFINED,
		['G'] = TOKEN_UNDEFINED_UNDEFINED,
		['H'] = TOKEN_UNDEFINED_UNDEFINED,
		['I'] = TOKEN_UNDEFINED_UNDEFINED,
		['J'] = TOKEN_UNDEFINED_UNDEFINED,
		['K'] = TOKEN_UNDEFINED_UNDEFINED,
		['L'] = TOKEN_UNDEFINED_UNDEFINED,
		['M'] = TOKEN_UNDEFINED_UNDEFINED,
		['N'] = TOKEN_UNDEFINED_UNDEFINED,
		['O'] = TOKEN_UNDEFINED_UNDEFINED,
		['P'] = TOKEN_UNDEFINED_UNDEFINED,
		['Q'] = TOKEN_UNDEFINED_UNDEFINED,
		['R'] = TOKEN_UNDEFINED_UNDEFINED,
		['S'] = TOKEN_UNDEFINED_UNDEFINED,
		['T'] = TOKEN_UNDEFINED_UNDEFINED,
		['U'] = TOKEN_UNDEFINED_UNDEFINED,
		['V'] = TOKEN_UNDEFINED_UNDEFINED,
		['W'] = TOKEN_UNDEFINED_UNDEFINED,
		['X'] = TOKEN_UNDEFINED_UNDEFINED,
		['Y'] = TOKEN_UNDEFINED_UNDEFINED,
		['Z'] = TOKEN_UNDEFINED_UNDEFINED,
		['['] = TOKEN_UNDEFINED_UNDEFINED,
		['\\'] = TOKEN_UNDEFINED_UNDEFINED,
		[']'] = TOKEN_UNDEFINED_UNDEFINED,
		['^'] = TOKEN_UNDEFINED_UNDEFINED,
		['_'] = TOKEN_UNDEFINED_UNDEFINED,
		['`'] = TOKEN_UNDEFINED_UNDEFINED,
		['a'] = TOKEN_UNDEFINED_UNDEFINED,
		['b'] = TOKEN_UNDEFINED_UNDEFINED,
		['c'] = TOKEN_UNDEFINED_UNDEFINED,
		['d'] = TOKEN_UNDEFINED_UNDEFINED,
		['e'] = TOKEN_UNDEFINED_UNDEFINED,
		['f'] = TOKEN_UNDEFINED_UNDEFINED,
		['g'] = TOKEN_UNDEFINED_UNDEFINED,
		['h'] = TOKEN_UNDEFINED_UNDEFINED,
		['i'] = TOKEN_UNDEFINED_UNDEFINED,
		['j'] = TOKEN_UNDEFINED_UNDEFINED,
		['k'] = TOKEN_UNDEFINED_UNDEFINED,
		['l'] = TOKEN_UNDEFINED_UNDEFINED,
		['m'] = TOKEN_UNDEFINED_UNDEFINED,
		['n'] = TOKEN_UNDEFINED_UNDEFINED,
		['o'] = TOKEN_UNDEFINED_UNDEFINED,
		['p'] = TOKEN_UNDEFINED_UNDEFINED,
		['q'] = TOKEN_UNDEFINED_UNDEFINED,
		['r'] = TOKEN_UNDEFINED_UNDEFINED,
		['s'] = TOKEN_UNDEFINED_UNDEFINED,
		['t'] = TOKEN_UNDEFINED_UNDEFINED,
		['u'] = TOKEN_UNDEFINED_UNDEFINED,
		['v'] = TOKEN_UNDEFINED_UNDEFINED,
		['w'] = TOKEN_UNDEFINED_UNDEFINED,
		['x'] = TOKEN_UNDEFINED_UNDEFINED,
		['y'] = TOKEN_UNDEFINED_UNDEFINED,
		['z'] = TOKEN_UNDEFINED_UNDEFINED,
		['{'] = TOKEN_UNDEFINED_UNDEFINED,
		['|'] = TOKEN_UNDEFINED_UNDEFINED,
		['}'] = TOKEN_UNDEFINED_UNDEFINED,
		['~'] = TOKEN_UNDEFINED_UNDEFINED,
		['\x7f'] = TOKEN_UNDEFINED_UNDEFINED
	},

	[TOKEN_STATE_BASIC] = {
		['\0'] = TOKEN_BASIC_UNDEFINED,
		['\x1'] = TOKEN_BASIC_UNDEFINED,
		['\x2'] = TOKEN_BASIC_UNDEFINED,
		['\x3'] = TOKEN_BASIC_UNDEFINED,
		['\x4'] = TOKEN_BASIC_UNDEFINED,
		['\x5'] = TOKEN_BASIC_UNDEFINED,
		['\x6'] = TOKEN_BASIC_UNDEFINED,
		['\x7'] = TOKEN_BASIC_UNDEFINED,
		['\x8'] = TOKEN_BASIC_UNDEFINED,
		['\t'] = TOKEN_BASIC_WSPACE,
		['\n'] = TOKEN_BASIC_WSPACE,
		['\xb'] = TOKEN_BASIC_UNDEFINED,
		['\xc'] = TOKEN_BASIC_UNDEFINED,
		['\r'] = TOKEN_BASIC_UNDEFINED,
		['\xe'] = TOKEN_BASIC_UNDEFINED,
		['\xf'] = TOKEN_BASIC_UNDEFINED,
		['\x10'] = TOKEN_BASIC_UNDEFINED,
		['\x11'] = TOKEN_BASIC_UNDEFINED,
		['\x12'] = TOKEN_BASIC_UNDEFINED,
		['\x13'] = TOKEN_BASIC_UNDEFINED,
		['\x14'] = TOKEN_BASIC_UNDEFINED,
		['\x15'] = TOKEN_BASIC_UNDEFINED,
		['\x16'] = TOKEN_BASIC_UNDEFINED,
		['\x17'] = TOKEN_BASIC_UNDEFINED,
		['\x18'] = TOKEN_BASIC_UNDEFINED,
		['\x19'] = TOKEN_BASIC_UNDEFINED,
		['\x1a'] = TOKEN_BASIC_UNDEFINED,
		['\x1b'] = TOKEN_BASIC_UNDEFINED,
		['\x1c'] = TOKEN_BASIC_UNDEFINED,
		['\x1d'] = TOKEN_BASIC_UNDEFINED,
		['\x1e'] = TOKEN_BASIC_UNDEFINED,
		['\x1f'] = TOKEN_BASIC_UNDEFINED,
		[' '] = TOKEN_BASIC_WSPACE,
		['!'] = TOKEN_BASIC_WORD,
		['"'] = TOKEN_BASIC_DQUOTE,
		['#'] = TOKEN_BASIC_WORD,
		['$'] = TOKEN_BASIC_EXPANSION,
		['%'] = TOKEN_BASIC_WORD,
		['&'] = TOKEN_BASIC_AND,
		['\''] = TOKEN_BASIC_SQUOTE,
		['('] = TOKEN_BASIC_WORD,
		[')'] = TOKEN_BASIC_WORD,
		['*'] = TOKEN_BASIC_WORD,
		['+'] = TOKEN_BASIC_WORD,
		[','] = TOKEN_BASIC_WORD,
		['-'] = TOKEN_BASIC_WORD,
		['.'] = TOKEN_BASIC_WORD,
		['/'] = TOKEN_BASIC_WORD,
		['0'] = TOKEN_BASIC_WORD,
		['2'] = TOKEN_BASIC_WORD,
		['1'] = TOKEN_BASIC_WORD,
		['3'] = TOKEN_BASIC_WORD,
		['4'] = TOKEN_BASIC_WORD,
		['5'] = TOKEN_BASIC_WORD,
		['6'] = TOKEN_BASIC_WORD,
		['7'] = TOKEN_BASIC_WORD,
		['8'] = TOKEN_BASIC_WORD,
		['9'] = TOKEN_BASIC_WORD,
		[':'] = TOKEN_BASIC_WORD,
		[';'] = TOKEN_BASIC_SEMICOLON,
		['<'] = TOKEN_BASIC_LESS,
		['='] = TOKEN_BASIC_WORD,
		['>'] = TOKEN_BASIC_WORD,
		['?'] = TOKEN_BASIC_WORD,
		['@'] = TOKEN_BASIC_WORD,
		['A'] = TOKEN_BASIC_WORD,
		['B'] = TOKEN_BASIC_WORD,
		['C'] = TOKEN_BASIC_WORD,
		['D'] = TOKEN_BASIC_WORD,
		['E'] = TOKEN_BASIC_WORD,
		['F'] = TOKEN_BASIC_WORD,
		['G'] = TOKEN_BASIC_WORD,
		['H'] = TOKEN_BASIC_WORD,
		['I'] = TOKEN_BASIC_WORD,
		['J'] = TOKEN_BASIC_WORD,
		['K'] = TOKEN_BASIC_WORD,
		['L'] = TOKEN_BASIC_WORD,
		['M'] = TOKEN_BASIC_WORD,
		['N'] = TOKEN_BASIC_WORD,
		['O'] = TOKEN_BASIC_WORD,
		['P'] = TOKEN_BASIC_WORD,
		['Q'] = TOKEN_BASIC_WORD,
		['R'] = TOKEN_BASIC_WORD,
		['S'] = TOKEN_BASIC_WORD,
		['T'] = TOKEN_BASIC_WORD,
		['U'] = TOKEN_BASIC_WORD,
		['V'] = TOKEN_BASIC_WORD,
		['W'] = TOKEN_BASIC_WORD,
		['X'] = TOKEN_BASIC_WORD,
		['Y'] = TOKEN_BASIC_WORD,
		['Z'] = TOKEN_BASIC_WORD,
		['['] = TOKEN_BASIC_WORD,
		['\\'] = TOKEN_BASIC_UNDEFINED,
		[']'] = TOKEN_BASIC_WORD,
		['^'] = TOKEN_BASIC_WORD,
		['_'] = TOKEN_BASIC_WORD,
		['`'] = TOKEN_BASIC_BQUOTE,
		['a'] = TOKEN_BASIC_WORD,
		['b'] = TOKEN_BASIC_WORD,
		['c'] = TOKEN_BASIC_WORD,
		['d'] = TOKEN_BASIC_WORD,
		['e'] = TOKEN_BASIC_WORD,
		['f'] = TOKEN_BASIC_WORD,
		['g'] = TOKEN_BASIC_WORD,
		['h'] = TOKEN_BASIC_WORD,
		['i'] = TOKEN_BASIC_WORD,
		['j'] = TOKEN_BASIC_WORD,
		['k'] = TOKEN_BASIC_WORD,
		['l'] = TOKEN_BASIC_WORD,
		['m'] = TOKEN_BASIC_WORD,
		['n'] = TOKEN_BASIC_WORD,
		['o'] = TOKEN_BASIC_WORD,
		['p'] = TOKEN_BASIC_WORD,
		['q'] = TOKEN_BASIC_WORD,
		['r'] = TOKEN_BASIC_WORD,
		['s'] = TOKEN_BASIC_WORD,
		['t'] = TOKEN_BASIC_WORD,
		['u'] = TOKEN_BASIC_WORD,
		['v'] = TOKEN_BASIC_WORD,
		['w'] = TOKEN_BASIC_WORD,
		['x'] = TOKEN_BASIC_WORD,
		['y'] = TOKEN_BASIC_WORD,
		['z'] = TOKEN_BASIC_WORD,
		['{'] = TOKEN_BASIC_WORD,
		['|'] = TOKEN_BASIC_PIPE,
		['}'] = TOKEN_BASIC_WORD,
		['~'] = TOKEN_BASIC_EXPANSION,
		['\x7f'] = TOKEN_BASIC_UNDEFINED
	}
};

int				(*g_token_basic_handler[12])() = {
	[TOKEN_BASIC_UNDEFINED] = 0,
	[TOKEN_BASIC_WSPACE] = 0,
	[TOKEN_BASIC_WORD] = 0,
	[TOKEN_BASIC_SQUOTE] = 0,
	[TOKEN_BASIC_DQUOTE] = 0,
	[TOKEN_BASIC_BQUOTE] = 0,
	[TOKEN_BASIC_SEMICOLON] = 0,
	[TOKEN_BASIC_PIPE] = 0,
	[TOKEN_BASIC_AND] = 0,
	[TOKEN_BASIC_LESS] = 0,
	[TOKEN_BASIC_GREAT] = 0,
	[TOKEN_BASIC_EXPANSION] = 0
};

#include "strft.h"

// int		lexer(t_array *input)
int		lexer(char *input, t_array *token)
{
	size_t	max;
	size_t	idx;
	int		ret;

	(void)token;
	ft_pf("lexer input: [%s]\n", input);
	ft_pf("sizeof(g_token_definition) = %u\n", (unsigned int)sizeof(g_token_definition));
	ft_pf("sizeof(g_token_basic_handler) = %u\n", (unsigned int)sizeof(g_token_basic_handler));
	max = ft_strlen(input);
	idx = 0;
	while (idx < max)
	{
		if (g_token_basic_handler[g_token_definition[TOKEN_STATE_BASIC][(int)input[idx]]] == 0)
		{
			ft_dpf(2, "Function token: undefined near [%u] => '%c' :(\n", idx, input[idx]);
			return (-1);
		}
		ret = g_token_basic_handler[g_token_definition[TOKEN_STATE_BASIC][(int)input[idx]]](&idx, &token, input[idx]);
		if (ret != 0)
		{
			if (ret == -1)
				ft_dpf(2, "Something happened near [%u] => '%c' :(\n", idx, input[idx]);
				else if (ret == 1)
				ft_pf("need closure :D\n");
			return (ret);
		}
		++idx;
	}
	return (0);
}
